name: Deploy Flask App to Hugging Face

on:
  workflow_dispatch:
    branches:
      - Live

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install gunicorn
          pip install --upgrade huggingface-hub

      - name: Start Flask server (background)
        run: |
          nohup python app.py &
          sleep 10

      - name: Call /health endpoint
        run: |
          echo "Calling health endpoint at http://127.0.0.1:7860/health"
          curl --fail http://127.0.0.1:7860/health || echo "Health check failed, but continuing..."

      - name: Deploy to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HUGGINGFACE_TOKEN }}
        run: |
          python << EOF
          from huggingface_hub import HfApi, login
          import os
          import sys
          
          token = os.environ.get('HF_TOKEN')
          if not token:
              print("Error: HF_TOKEN not set!")
              sys.exit(1)
          
          print("Logging in to Hugging Face...")
          try:
              login(token=token, add_to_git_credential=False)
          except Exception as e:
              print(f"Login failed: {e}")
              sys.exit(1)
          
          print("Uploading to Hugging Face Space...")
          api = HfApi(token=token)
          try:
              # First, explicitly upload the database file to ensure it's included
              import os
              if os.path.exists('stackoverflow.db'):
                  db_size = os.path.getsize('stackoverflow.db')
                  print(f"Found database file: stackoverflow.db ({db_size / (1024*1024):.2f} MB)")
                  api.upload_file(
                      path_or_fileobj='stackoverflow.db',
                      path_in_repo='stackoverflow.db',
                      repo_id='SaiSankarSwarna/SwaRAG',
                      repo_type='space',
                      commit_message='Upload database file'
                  )
                  print("Database file uploaded successfully!")
              else:
                  print("Warning: stackoverflow.db not found in current directory")
              
              # Then upload the rest of the files
              api.upload_folder(
                  folder_path='.',
                  repo_id='SaiSankarSwarna/SwaRAG',
                  repo_type='space',
                  ignore_patterns=['__pycache__', '.git', '*.pyc', '.github', '*.log', 'stackoverflow.db'],
                  commit_message='Deploy from GitHub Actions'
              )
              print("Deployment complete!")
          except Exception as e:
              print(f"Upload failed: {e}")
              sys.exit(1)
          EOF